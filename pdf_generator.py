"""
pdf_generator.py â€” PDF report generation using fpdf2.
"""

import io
from fpdf import FPDF


class HealthPDF(FPDF):
    """Custom PDF layout for HealthAI reports."""

    def header(self):
        self.set_font("Helvetica", "B", 20)
        self.set_text_color(56, 189, 248)
        self.cell(0, 12, "HealthAI - Health Assessment Report", new_x="LMARGIN", new_y="NEXT", align="C")
        self.set_draw_color(56, 189, 248)
        self.line(10, 22, 200, 22)
        self.ln(8)

    def footer(self):
        self.set_y(-15)
        self.set_font("Helvetica", "I", 8)
        self.set_text_color(130, 130, 130)
        self.cell(0, 10, f"HealthAI Report - Page {self.page_no()}/{{nb}}", align="C")

    def section_title(self, title):
        self.set_font("Helvetica", "B", 13)
        self.set_text_color(56, 189, 248)
        self.cell(0, 10, title, new_x="LMARGIN", new_y="NEXT")
        self.ln(2)

    def body_text(self, text):
        self.set_font("Helvetica", "", 10)
        self.set_text_color(50, 50, 50)
        self.multi_cell(0, 6, text)
        self.ln(2)

    def bullet(self, text):
        self.set_font("Helvetica", "", 10)
        self.set_text_color(50, 50, 50)
        self.cell(5)
        self.cell(0, 6, f"- {text}", new_x="LMARGIN", new_y="NEXT")


def generate_pdf_report(patient_data: dict, diagnosis: dict, recommendations: dict) -> bytes:
    """Generate a PDF report and return as bytes."""
    pdf = HealthPDF()
    pdf.alias_nb_pages()
    pdf.add_page()

    # Patient Summary
    pdf.section_title("Patient Summary")
    pdf.body_text(f"Patient Name: {patient_data.get('name', 'Not Provided')}")
    pdf.body_text(f"Age: {patient_data.get('age', 'N/A')}  |  Gender: {patient_data.get('gender', 'N/A')}")
    pdf.body_text(f"Primary Complaint: {patient_data.get('complaint', 'N/A')}")
    if patient_data.get("duration"):
        pdf.body_text(f"Duration: {patient_data['duration']}  |  Severity: {patient_data.get('severity', 'N/A')}")
    pdf.ln(4)

    # Symptoms
    pdf.section_title("Symptoms Identified")
    for s in diagnosis.get("extracted_symptoms", []):
        pdf.bullet(s.title())
    pdf.ln(4)

    # Conditions
    pdf.section_title("Possible Conditions")
    for c in diagnosis.get("top_conditions", []):
        pdf.set_font("Helvetica", "B", 11)
        pdf.set_text_color(50, 50, 50)
        pdf.cell(0, 7, f"{c['name']} - {c['confidence']} ({c.get('confidence_score', 'N/A')}%)",
                 new_x="LMARGIN", new_y="NEXT")
        pdf.set_font("Helvetica", "", 9)
        pdf.set_text_color(100, 100, 100)
        pdf.cell(0, 5, c.get("reasoning", ""), new_x="LMARGIN", new_y="NEXT")
        pdf.ln(3)
    pdf.ln(2)

    # Recommendations
    pdf.section_title("You Can Use These Medicines & Treatments")
    for rec in recommendations.get("recommendations", []):
        pdf.set_font("Helvetica", "B", 11)
        pdf.set_text_color(56, 189, 248)
        pdf.cell(0, 8, rec.get("condition", ""), new_x="LMARGIN", new_y="NEXT")

        pdf.set_font("Helvetica", "B", 10)
        pdf.set_text_color(50, 50, 50)

        pdf.cell(0, 6, "You can use these medicines:", new_x="LMARGIN", new_y="NEXT")
        for m in rec.get("medicines", []):
            pdf.bullet(m)

        pdf.cell(0, 6, "Home Remedies:", new_x="LMARGIN", new_y="NEXT")
        for h in rec.get("home_remedies", []):
            pdf.bullet(h)

        pdf.cell(0, 6, "Dietary Advice:", new_x="LMARGIN", new_y="NEXT")
        for d in rec.get("dietary_advice", []):
            pdf.bullet(d)

        pdf.cell(0, 6, "Lifestyle Changes:", new_x="LMARGIN", new_y="NEXT")
        for lc in rec.get("lifestyle_changes", []):
            pdf.bullet(lc)

        pdf.body_text(f"Appropriate Specialist: {rec.get('specialist', 'General Physician')}")
        pdf.ln(2)

    # Warning
    warn = recommendations.get("urgent_warning")
    if warn:
        pdf.section_title("Important Warning")
        pdf.set_text_color(200, 50, 50)
        pdf.body_text(warn)

    # Disclaimer
    pdf.section_title("Disclaimer")
    pdf.set_font("Helvetica", "I", 9)
    pdf.set_text_color(130, 130, 130)
    pdf.multi_cell(0, 5,
        "This report is generated by an AI health assistant and is for informational "
        "purposes only. It is NOT a substitute for professional medical diagnosis or "
        "treatment. Please consult a qualified healthcare provider."
    )

    return pdf.output()
